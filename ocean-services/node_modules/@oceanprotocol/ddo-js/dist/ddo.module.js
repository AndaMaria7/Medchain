import{createHash as t}from"crypto";import{ethers as e}from"ethers";import{dirname as n,resolve as a}from"path";import{fromRdf as r}from"rdf-literal";import{Readable as i}from"stream";import{fileURLToPath as d}from"url";import{existsSync as s}from"fs";function o(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,a=Array(e);n<e;n++)a[n]=t[n];return a}function l(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(n)return(n=n.call(t)).next.bind(n);if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return o(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?o(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var a=0;return function(){return a>=t.length?{done:!0}:{done:!1,value:t[a++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function u(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,c(t,e)}function c(t,e){return c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},c(t,e)}var f,h,v,D,p=function(){try{var t=function(){function t(){function t(){return{formats:v,rdf:f,SHACLValidator:h}}var e=function(){if(!h)return Promise.resolve(import("rdf-validate-shacl")).then(function(t){h=t.default})}();return e&&e.then?e.then(t):t()}var e=function(){if(!f)return Promise.resolve(import("@zazuko/env-node")).then(function(t){(f=t.default).formats.import(v)})}();return e&&e.then?e.then(t):t()},e=function(){if(!v)return Promise.resolve(import("@rdfjs/formats-common")).then(function(t){v=t.default})}();return Promise.resolve(e&&e.then?e.then(t):t())}catch(t){return Promise.reject(t)}},m=function(t){try{return Promise.resolve(function(e,n){try{var a=(r=O.getDDOClass(t),Promise.resolve(r.validate()))}catch(t){return n(t)}var r;return a&&a.then?a.then(void 0,n):a}(0,function(t){return[!1,{general:["Validation failed: "+t]}]}))}catch(t){return Promise.reject(t)}},g=["4.1.0","4.3.0","4.5.0","4.7.0","5.0.0","deprecated"],O=/*#__PURE__*/function(){function t(t){this.ddoData=void 0,this.ddoData=t}var e=t.prototype;return e.getDDOData=function(){return this.ddoData},e.deleteIndexedMetadataIfExists=function(t){var e=structuredClone(t);return"indexedMetadata"in e?(delete e.indexedMetadata,e):t},e.getDid=function(){return this.getDDOData().id||null},e.getSchema=function(t){if(void 0===t&&(t="5.0.0"),!g.includes(t))throw new Error("Unsupported schema version: "+t);var e=d(import.meta.url),r=n(e),i=a(r,"../schemas/"+t+".ttl");return s(i)?i:a(r,"../../schemas/"+t+".ttl")},t.getDDOClass=function(t){var e=t.version,n=t.id;if(e.startsWith("4")&&n.startsWith("did:op"))return new y(t);if(e.startsWith("5")&&n.startsWith("did:ope"))return new A(t);if("deprecated"===e)return new x(t);throw new Error("Unsupported DDO version: "+e)},t}(),y=/*#__PURE__*/function(n){function a(t){return n.call(this,t)||this}u(a,n);var d=a.prototype;return d.getDDOFields=function(){var t=this.getDDOData();return{id:t.id||null,version:t.version||null,metadata:t.metadata||null,services:t.services||null,chainId:t.chainId||null,credentials:t.credentials||null,nftAddress:t.nftAddress||null}},d.getAssetFields=function(){return{indexedMetadata:this.getDDOData().indexedMetadata,datatokens:this.getDDOData().datatokens}},d.makeDid=function(n,a){return"did:op:"+t("sha256").update(e.utils.getAddress(n)+a).digest("hex")},d.updateFields=function(t){var e,n,a,r;return t.id&&(this.getDDOData().id=t.id),t.nftAddress&&(this.getDDOData().nftAddress=t.nftAddress),t.chainId&&(this.getDDOData().chainId=t.chainId),t.datatokens&&(this.getDDOData().datatokens=t.datatokens),null!=(e=t.indexedMetadata)&&e.nft&&(this.getDDOData().indexedMetadata.nft=t.indexedMetadata.nft),null!=(n=t.indexedMetadata)&&n.event&&(this.getDDOData().indexedMetadata.event=t.indexedMetadata.event),null!=(a=t.indexedMetadata)&&a.purgatory&&(this.getDDOData().indexedMetadata.purgatory=t.indexedMetadata.purgatory),t.services&&(this.getDDOData().services=t.services),null!=(r=t.indexedMetadata)&&r.stats&&(this.getDDOData().indexedMetadata.stats=t.indexedMetadata.stats),this.getDDOData()},d.validate=function(){try{var t=this;return Promise.resolve(p()).then(function(n){var a=n.rdf,d=n.formats,s=n.SHACLValidator,o=t.deleteIndexedMetadataIfExists(t.getDDOData()),u=JSON.parse(JSON.stringify(o)),c=u.chainId,f=u.nftAddress,h={};u["@type"]="DDO",u["@context"]={"@vocab":"http://schema.org/"},c||("chainId"in h||(h.chainId=[]),h.chainId.push("chainId is missing or invalid."));try{e.utils.getAddress(f)}catch(t){"nftAddress"in h||(h.nftAddress=[]),h.nftAddress.push("nftAddress is missing or invalid.")}t.makeDid(f,c.toString(10))!==u.id&&("id"in h||(h.id=[]),h.id.push("did is not valid for chain Id and nft address"));var v=t.getSchema(u.version);return Promise.resolve(a.dataset().import(a.fromFile(v))).then(function(t){var e=i.from(JSON.stringify(u)),n=d.parsers.import("application/ld+json",e);return n?Promise.resolve(a.dataset().import(n)).then(function(e){var n=new s(t,{factory:a});return Promise.resolve(n.validate(e)).then(function(t){if(t.conforms)return[!0,{}];for(var e,n=l(t.results);!(e=n()).done;){var a,i=e.value,d=null==(a=i.path)?void 0:a.value.replace("http://schema.org/","");d&&(d in h||(h[d]=[]),h[d].push(r(i.message[0])))}return Promise.resolve(t.dataset.serialize({format:"application/ld+json"})).then(function(t){return h.fullReport=t,[!1,h]})})}):(h.output=["Output is null or invalid"],[!1,h])})})}catch(t){return Promise.reject(t)}},a}(O),A=/*#__PURE__*/function(n){function a(t){return n.call(this,t)||this}u(a,n);var r=a.prototype;return r.makeDid=function(n,a){return"did:ope:"+t("sha256").update(e.utils.getAddress(n)+a).digest("hex")},r.getDDOFields=function(){var t,e,n,a,r,i=this.getDDOData();return{id:(null==i?void 0:i.id)||null,version:(null==i?void 0:i.version)||null,metadata:(null==(t=i.credentialSubject)?void 0:t.metadata)||null,services:(null==(e=i.credentialSubject)?void 0:e.services)||null,chainId:(null==(n=i.credentialSubject)?void 0:n.chainId)||null,credentials:(null==(a=i.credentialSubject)?void 0:a.credentials)||null,nftAddress:(null==(r=i.credentialSubject)?void 0:r.nftAddress)||null}},r.getAssetFields=function(){var t,e;return{indexedMetadata:null==(t=this.getDDOData())?void 0:t.indexedMetadata,datatokens:null==(e=this.getDDOData().credentialSubject)?void 0:e.datatokens}},r.getProof=function(){return this.getDDOData().proof},r.getIssuer=function(){return this.getDDOData().issuer},r.updateFields=function(t){var e,n,a,r,i=this.getDDOData().credentialSubject||{};return t.id&&(this.getDDOData().id=t.id),t.nftAddress&&(i.nftAddress=t.nftAddress),t.chainId&&(i.chainId=t.chainId),t.datatokens&&(i.datatokens=t.datatokens),null!=(e=t.indexedMetadata)&&e.nft&&(this.getDDOData().indexedMetadata.nft=t.indexedMetadata.nft),null!=(n=t.indexedMetadata)&&n.event&&(this.getDDOData().indexedMetadata.event=t.indexedMetadata.event),null!=(a=t.indexedMetadata)&&a.purgatory&&(this.getDDOData().indexedMetadata.purgatory=t.indexedMetadata.purgatory),t.services&&(i.services=t.services),null!=(r=t.indexedMetadata)&&r.stats&&(this.getDDOData().indexedMetadata.stats=t.indexedMetadata.stats),t.issuer&&(this.getDDOData().issuer=t.issuer),t.proof&&(this.getDDOData().proof=t.proof),this.getDDOData().credentialSubject=i,this.getDDOData()},r.validate=function(){try{var t=this;return Promise.resolve(p()).then(function(n){var a=n.rdf,r=n.formats,d=n.SHACLValidator,s=t.deleteIndexedMetadataIfExists(t.getDDOData()),o=JSON.parse(JSON.stringify(s)),u=o.credentialSubject,c=u.chainId,f=u.nftAddress,h={};o["@type"]="VerifiableCredential",o["@context"]={"@vocab":"https://www.w3.org/ns/credentials/v2/"},o.credentialSubject.chainId||(h.chainId=["chainId is missing or invalid."]);try{e.utils.getAddress(f)}catch(t){h.nftAddress=["nftAddress is missing or invalid."]}t.makeDid(f,c.toString(10))!==o.id&&(h.id=["did is not valid for chainId and nft address"]),o.credentialSubject.metadata||(h.metadata=["metadata is missing or invalid."]),o.credentialSubject.services||(h.services=["services are missing or invalid."]);var v=t.getSchema(o.version);return Promise.resolve(a.dataset().import(a.fromFile(v))).then(function(t){var e=i.from(JSON.stringify(o)),n=r.parsers.import("application/ld+json",e);return n?Promise.resolve(a.dataset().import(n)).then(function(e){var n=new d(t,{factory:a});return Promise.resolve(n.validate(e)).then(function(t){if(t.conforms)return[!0,{}];for(var e,n=l(t.results);!(e=n()).done;){var a,r=e.value,i=null==r||null==(a=r.path)?void 0:a.value.replace("https://www.w3.org/ns/credentials/v2/","");i&&(i in h||(h[i]=[]),h[i].push(r.message[0].value))}return Promise.resolve(t.dataset.serialize({format:"application/ld+json"})).then(function(t){return h.fullReport=t,[!1,h]})})}):(h.output=["Output is null or invalid"],[!1,h])})})}catch(t){return Promise.reject(t)}},a}(O),x=/*#__PURE__*/function(n){function a(t){return n.call(this,t)||this}u(a,n);var d=a.prototype;return d.makeDid=function(n,a){return"did:op:"+t("sha256").update(e.utils.getAddress(n)+a).digest("hex")},d.getDDOFields=function(){var t=this.getDDOData();return{id:(null==t?void 0:t.id)||null,version:"deprecated",chainId:(null==t?void 0:t.chainId)||null,nftAddress:(null==t?void 0:t.nftAddress)||null,metadata:null,services:null,credentials:null}},d.getAssetFields=function(){var t=this.getDDOData().indexedMetadata;return t.event=null,t.purgatory=null,t.stats=null,t.nft={state:this.getDDOData().indexedMetadata.nft.state,address:null,name:null,symbol:null,owner:null,created:null,tokenURI:null},{indexedMetadata:t,datatokens:null}},d.updateFields=function(t){var e,n=this.getDDOData()||{};return t.id&&(n.id=t.id),t.nftAddress&&(n.nftAddress=t.nftAddress),t.chainId&&(n.chainId=t.chainId),null!=(e=t.indexedMetadata)&&null!=(e=e.nft)&&e.state&&(n.indexedMetadata.nft.state=t.indexedMetadata.nft.state),n},d.validate=function(){try{var t=this;return Promise.resolve(p()).then(function(n){var a=n.rdf,d=n.formats,s=n.SHACLValidator,o=t.deleteIndexedMetadataIfExists(t.getDDOData()),u=JSON.parse(JSON.stringify(o)),c=u.chainId,f=u.nftAddress,h={};u["@type"]="DDO",u["@context"]={"@vocab":"http://schema.org/"},c||("chainId"in h||(h.chainId=[]),h.chainId.push("chainId is missing or invalid."));try{e.utils.getAddress(f)}catch(t){"nftAddress"in h||(h.nftAddress=[]),h.nftAddress.push("nftAddress is missing or invalid.")}t.makeDid(f,c.toString(10))!==u.id&&("id"in h||(h.id=[]),h.id.push("did is not valid for chain Id and nft address"));var v=t.getSchema(u.version);return Promise.resolve(a.dataset().import(a.fromFile(v))).then(function(t){var e=i.from(JSON.stringify(u)),n=d.parsers.import("application/ld+json",e);return n?Promise.resolve(a.dataset().import(n)).then(function(e){var n=new s(t,{factory:a});return Promise.resolve(n.validate(e)).then(function(t){if(t.conforms)return[!0,{}];for(var e,n=l(t.results);!(e=n()).done;){var a,i=e.value,d=null==(a=i.path)?void 0:a.value.replace("http://schema.org/","");d&&(d in h||(h[d]=[]),h[d].push(r(i.message[0])))}return Promise.resolve(t.dataset.serialize({format:"application/ld+json"})).then(function(t){return h.fullReport=t,[!1,h]})})}):(h.output=["Output is null or invalid"],[!1,h])})})}catch(t){return Promise.reject(t)}},a}(O);!function(t){t.ADDRESS="address",t.ACCESS_LIST="accessList",t.POLICY_SERVER_SPECIFIC="PS-specific Type"}(D||(D={}));var I,S=[D.ADDRESS,D.ACCESS_LIST];!function(t){t[t.Active=0]="Active",t[t.EndOfLife=1]="EndOfLife",t[t.Deprecated=2]="Deprecated",t[t.RevokedByPublisher=3]="RevokedByPublisher",t[t.OrderingIsTemporaryDisabled=4]="OrderingIsTemporaryDisabled",t[t.AssetUnlisted=5]="AssetUnlisted"}(I||(I={}));export{D as CREDENTIALS_TYPES,O as DDOManager,x as DeprecatedDDO,S as KNOWN_CREDENTIALS_TYPES,I as State,y as V4DDO,A as V5DDO,m as validateDDO};
//# sourceMappingURL=ddo.module.js.map
